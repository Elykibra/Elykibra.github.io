<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kyle Tolilic - Automation Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b0f1a;
            color: #E5E7EB;
            overflow: hidden;
        }
        .canvas-grid {
            background-image: radial-gradient(#2d3748 1px, transparent 1px);
            background-size: 30px 30px;
        }
        .node-card {
            background: rgba(31, 41, 55, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid #374151;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .node-card.processing {
            border-color: #FBBF24;
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.2);
            transform: translateY(-4px) scale(1.02);
        }
        .node-card.failed {
            border-color: #EF4444;
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.2);
        }
        .line-flow {
            stroke-dasharray: 8;
            animation: flow 30s linear infinite;
        }
        @keyframes flow {
            from { stroke-dashoffset: 500; }
            to { stroke-dashoffset: 0; }
        }
        .data-packet {
            fill: #FBBF24;
            filter: drop-shadow(0 0 8px #FBBF24);
            transition: fill 0.3s;
        }
        .data-packet.error-packet {
            fill: #EF4444;
            filter: drop-shadow(0 0 8px #EF4444);
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        .console-scrollbar::-webkit-scrollbar { width: 4px; }
        .console-scrollbar::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
        
        #terminal-input:focus { outline: none; }
        .cursor-blink { animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        .glow-pulse {
            position: absolute;
            inset: -2px;
            border-radius: 0.75rem;
            background: linear-gradient(45deg, #FBBF24, transparent, #FBBF24);
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s;
        }
        .processing .glow-pulse {
            opacity: 0.4;
            animation: rotateGlow 2s linear infinite;
        }
        @keyframes rotateGlow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        .toggle-btn.active {
            background-color: #FBBF24;
            color: #0b0f1a;
            font-weight: 800;
        }

        .exec-card {
            background: linear-gradient(145deg, rgba(31, 41, 55, 0.4), rgba(15, 23, 42, 0.6));
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.3s ease;
        }
        
        /* Mobile Specific Overrides */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100%;
                width: 85%;
                transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 20px 0 50px rgba(0,0,0,0.5);
                z-index: 100;
            }
            #sidebar.open {
                left: 0;
            }
            #sidebar-overlay {
                transition: opacity 0.3s ease;
            }
            #sidebar-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }
            #sidebar-overlay.hidden-overlay {
                opacity: 0;
                pointer-events: none;
            }
        }

        /* Prevent scroll chaining on mobile */
        #view-architect {
            overscroll-behavior: contain;
        }
    </style>
</head>
<body class="antialiased h-screen flex flex-col md:flex-row">

    <!-- Mobile Sidebar Overlay -->
    <div id="sidebar-overlay" onclick="toggleMobileMenu()" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden-overlay md:hidden z-40"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-full md:w-80 bg-gray-900 border-r border-gray-800 p-6 flex flex-col h-full z-50">
        <div class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-black text-white tracking-tight uppercase">Kyle Tolilic</h1>
                <p class="text-amber-500 font-bold text-xs mt-1 uppercase tracking-widest">Automation Architect</p>
            </div>
            <button onclick="toggleMobileMenu()" class="md:hidden p-2 text-gray-400 hover:text-white transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <nav class="space-y-6 flex-grow overflow-y-auto pr-2 console-scrollbar">
            <div>
                <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3">Intelligence Systems</h3>
                <div class="space-y-2">
                    <button onclick="loadScenario('mother-ai')" id="btn-mother-ai" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 border border-transparent text-gray-400 text-sm font-medium flex items-center justify-between transition-all group">
                        <span>Mother AI Orchestrator</span>
                        <i data-lucide="cpu" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <div>
                <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3">Diagnostic Reports</h3>
                <div class="space-y-2">
                    <button onclick="loadScenario('zapier-debug')" id="btn-zapier-debug" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 border border-transparent text-gray-400 text-sm font-medium flex items-center justify-between transition-all group">
                        <span>Failed Payment Debug</span>
                        <i data-lucide="bug" class="w-4 h-4"></i>
                    </button>
                    <button onclick="loadScenario('ai-validation')" id="btn-ai-validation" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 border border-transparent text-gray-400 text-sm font-medium flex items-center justify-between transition-all group">
                        <span>AI Validation Flow</span>
                        <i data-lucide="shield-check" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <div>
                <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3">Production Pipelines</h3>
                <div class="space-y-2">
                    <button onclick="loadScenario('attorney')" id="btn-attorney" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 border border-transparent text-gray-400 text-sm font-medium flex items-center justify-between transition-all group">
                        <span>Attorney Pipeline v2.0</span>
                        <i data-lucide="briefcase" class="w-4 h-4"></i>
                    </button>
                    <button onclick="loadScenario('helpscout')" id="btn-helpscout" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 border border-transparent text-gray-400 text-sm font-medium flex items-center justify-between transition-all group">
                        <span>Help Scout Sage</span>
                        <i data-lucide="message-square" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <div class="pt-6 border-t border-gray-800 space-y-4">
                <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1">Connect</h3>
                <a href="mailto:ktolilic@gmail.com" class="flex items-center space-x-3 text-sm text-gray-400 hover:text-amber-500 transition-colors">
                    <i data-lucide="mail" class="w-4 h-4"></i>
                    <span>ktolilic@gmail.com</span>
                </a>
                <div class="flex items-center space-x-4">
                    <a href="https://github.com/Elykibra" target="_blank" class="text-gray-500 hover:text-white transition-colors">
                        <i data-lucide="github" class="w-5 h-5"></i>
                    </a>
                    <a href="https://www.linkedin.com/in/kyle-tolilic" target="_blank" class="text-gray-500 hover:text-white transition-colors">
                        <i data-lucide="linkedin" class="w-5 h-5"></i>
                    </a>
                    <a href="https://www.behance.net/kyle_tolilic" target="_blank" class="text-gray-500 hover:text-white transition-colors">
                        <i data-lucide="palette" class="w-5 h-5"></i>
                    </a>
                </div>
            </div>
        </nav>
    </aside>

    <!-- Main Workspace -->
    <main class="flex-grow relative overflow-hidden flex flex-col bg-[#0b0f1a]">
        <!-- Global Header -->
        <header class="p-3 md:p-4 bg-gray-900/80 backdrop-blur-md border-b border-gray-800 flex flex-col md:flex-row gap-4 justify-between items-center z-20">
            <div class="flex items-center w-full md:w-auto justify-between md:justify-start gap-4">
                <div class="flex items-center gap-3">
                    <button onclick="toggleMobileMenu()" class="md:hidden p-2 -ml-2 text-gray-400 hover:text-amber-500 transition-all">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    <h2 id="scenario-title" class="text-xs md:text-sm font-bold text-white uppercase tracking-wider truncate max-w-[140px] md:max-w-none">Scenario Name</h2>
                </div>
                
                <div class="h-6 w-px bg-gray-800 hidden md:block"></div>
                
                <!-- View Mode Toggle -->
                <div class="flex p-1 bg-black/40 rounded-lg border border-white/5 flex-shrink-0">
                    <button onclick="setViewMode('architect')" id="mode-architect" class="toggle-btn active px-3 md:px-5 py-2 rounded text-[9px] md:text-[10px] uppercase tracking-widest transition-all">Architect View</button>
                    <button onclick="setViewMode('executive')" id="mode-executive" class="toggle-btn px-3 md:px-5 py-2 rounded text-[9px] md:text-[10px] uppercase tracking-widest transition-all text-gray-500">Executive Summary</button>
                </div>
            </div>

            <!-- Action Controls -->
            <div class="flex items-center gap-2 w-full md:w-auto justify-end md:justify-start">
                <button onclick="toggleTerminal()" id="term-btn" class="flex items-center gap-2 px-3 py-1.5 bg-gray-800 border border-gray-700 rounded-full text-gray-400 text-[9px] md:text-[10px] font-black uppercase tracking-widest hover:border-amber-500/50 hover:text-white transition-all">
                    <i data-lucide="terminal" class="w-3 h-3"></i>
                    <span>Console</span>
                </button>
                <div class="h-4 w-px bg-gray-800"></div>
                <button onclick="startSimulation()" id="sim-btn" class="flex items-center gap-2 px-4 py-1.5 bg-amber-500/10 border border-amber-500/50 rounded-full text-amber-500 text-[9px] md:text-[10px] font-black uppercase tracking-widest hover:bg-amber-500 hover:text-gray-900 transition-all">
                    <i data-lucide="play" class="w-3 h-3"></i>
                    <span>Trace Logic</span>
                </button>
            </div>
        </header>

        <!-- Architect View (Canvas) -->
        <div id="view-architect" class="flex-grow canvas-grid relative overflow-auto cursor-grab active:cursor-grabbing scroll-smooth">
            <div class="relative w-[1800px] md:w-[2400px] h-[1000px] md:h-[1200px]">
                <svg id="svg-layer" class="absolute top-0 left-0 w-full h-full pointer-events-none z-0"></svg>
                <div id="node-layer" class="absolute top-0 left-0 w-full h-full z-10"></div>
            </div>
            
            <!-- Live Terminal Overlay -->
            <div id="live-terminal" class="fixed md:absolute bottom-6 left-4 right-4 md:left-6 md:right-6 h-48 md:h-56 bg-black/95 backdrop-blur-xl border border-white/10 rounded-xl z-30 overflow-hidden flex flex-col transition-all duration-300 shadow-2xl opacity-0 pointer-events-none translate-y-10">
                <div class="flex items-center justify-between px-4 py-2 bg-white/5 border-b border-white/5">
                    <span class="text-[9px] font-black uppercase tracking-widest text-gray-500">System Trace Log</span>
                    <button onclick="toggleTerminal(false)" class="text-gray-500 hover:text-white">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
                <div id="log-container" class="p-4 text-[10px] mono text-gray-400 space-y-1 overflow-y-auto flex-grow console-scrollbar"></div>
                <div class="p-3 bg-black/40 border-t border-white/5 flex items-center space-x-2">
                    <span class="text-amber-500 text-xs mono font-bold ml-1">></span>
                    <input type="text" id="terminal-input" placeholder="Inject data (e.g. 'fail', 'won')..." class="bg-transparent border-none text-amber-500 text-xs mono w-full focus:ring-0 placeholder:text-gray-700" autocomplete="off">
                </div>
            </div>
        </div>

        <!-- Executive View (Summary) -->
        <div id="view-executive" class="hidden flex-grow overflow-y-auto bg-[#0b0f1a] p-5 md:p-12 flex flex-col items-center console-scrollbar">
            <div class="max-w-4xl w-full space-y-8 md:space-y-12 pb-20">
                <div class="space-y-4 border-l-4 border-amber-500 pl-4 md:pl-8">
                    <h2 class="text-2xl md:text-4xl font-black text-white uppercase tracking-tighter leading-tight" id="exec-title">Scenario Title</h2>
                    <div class="flex flex-wrap items-center gap-2 md:gap-3">
                        <span class="px-3 py-1 bg-amber-500/10 text-amber-500 text-[9px] md:text-[10px] font-black uppercase tracking-widest rounded-full border border-amber-500/20" id="exec-intent">Intent</span>
                        <span class="text-gray-600 text-[9px] md:text-[10px] font-bold uppercase tracking-widest">Architectural Case Study</span>
                    </div>
                </div>

                <!-- Problem/Solution/Outcome Stack -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-8">
                    <div class="exec-card p-6 md:p-8 rounded-2xl md:rounded-3xl">
                        <div class="flex items-center space-x-3 mb-4 text-gray-400">
                            <i data-lucide="alert-circle" class="w-4 h-4"></i>
                            <h4 class="text-[10px] font-black uppercase tracking-widest">The Problem</h4>
                        </div>
                        <p id="exec-problem" class="text-xs md:text-sm text-gray-300 leading-relaxed font-medium"></p>
                    </div>
                    <div class="exec-card p-6 md:p-8 rounded-2xl md:rounded-3xl">
                        <div class="flex items-center space-x-3 mb-4 text-amber-500">
                            <i data-lucide="cpu" class="w-4 h-4"></i>
                            <h4 class="text-[10px] font-black uppercase tracking-widest">The Solution</h4>
                        </div>
                        <p id="exec-solution" class="text-xs md:text-sm text-gray-300 leading-relaxed font-medium"></p>
                    </div>
                    <div class="exec-card p-6 md:p-8 rounded-2xl md:rounded-3xl">
                        <div class="flex items-center space-x-3 mb-4 text-green-500">
                            <i data-lucide="check-circle" class="w-4 h-4"></i>
                            <h4 class="text-[10px] font-black uppercase tracking-widest">The Outcome</h4>
                        </div>
                        <p id="exec-result" class="text-xs md:text-sm text-gray-300 leading-relaxed font-medium"></p>
                    </div>
                </div>

                <!-- KPI Panel -->
                <div class="bg-gray-900/50 border border-white/5 p-6 md:p-10 rounded-2xl md:rounded-[3rem] relative overflow-hidden">
                    <h4 class="text-[9px] md:text-[11px] font-black text-amber-500 uppercase mb-8 md:mb-10 tracking-[0.2em] text-center">Business Intelligence & Performance</h4>
                    <div id="exec-kpis" class="grid grid-cols-2 md:grid-cols-4 gap-6 md:gap-12 relative z-10"></div>
                </div>

                <!-- Strategic Sections -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                    <div class="space-y-6">
                        <h4 class="text-[10px] font-black text-gray-500 uppercase tracking-widest flex items-center gap-2">
                            <i data-lucide="shield-alert" class="w-3 h-3"></i> Strategic Guardrails
                        </h4>
                        <div id="exec-restraint" class="bg-black/20 p-6 md:p-8 rounded-2xl md:rounded-3xl border border-white/5 text-xs md:text-sm text-gray-400 italic leading-relaxed"></div>
                    </div>
                    <div class="space-y-6">
                        <h4 class="text-[10px] font-black text-gray-500 uppercase tracking-widest flex items-center gap-2">
                            <i data-lucide="target" class="w-3 h-3"></i> Core Value Add
                        </h4>
                        <div id="exec-value" class="bg-amber-500/5 p-6 md:p-8 rounded-2xl md:rounded-3xl border border-amber-500/10 text-xs md:text-sm text-amber-100/70 leading-relaxed"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inspection Drawer -->
        <div id="drawer" class="fixed top-0 right-0 h-full w-full md:w-[520px] bg-[#0f172a] border-l border-white/10 shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-[60] flex flex-col">
            <div class="p-5 md:p-6 border-b border-white/5 flex justify-between items-center bg-gray-900/50">
                <div class="flex items-center space-x-4">
                    <div id="drawer-icon" class="p-3 bg-amber-500/20 rounded-xl text-amber-500 border border-amber-500/20"></div>
                    <div>
                        <h3 id="drawer-name" class="text-lg md:text-xl font-bold text-white">Node Name</h3>
                        <p id="drawer-type" class="text-[10px] uppercase tracking-widest text-gray-500 font-bold">Step Type</p>
                    </div>
                </div>
                <button onclick="closeDrawer()" class="p-2 hover:bg-white/5 rounded-full text-gray-400 transition-all">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="p-6 md:p-8 space-y-8 overflow-y-auto flex-grow console-scrollbar">
                <section id="drawer-why-section" class="bg-blue-500/5 border border-blue-500/20 p-5 rounded-2xl hidden">
                    <h4 class="text-[10px] font-bold text-blue-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                        <i data-lucide="info" class="w-3 h-3"></i> Why this shape?
                    </h4>
                    <p id="drawer-design-note" class="text-sm text-blue-100/80 leading-relaxed italic"></p>
                </section>

                <section class="bg-amber-500/5 border border-amber-500/20 p-5 rounded-2xl">
                    <h4 class="text-[10px] font-bold text-amber-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                        <i data-lucide="lightbulb" class="w-3 h-3"></i> Plain English Metaphor
                    </h4>
                    <p id="drawer-metaphor" class="text-sm text-amber-100/90 leading-relaxed italic"></p>
                </section>

                <section>
                    <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                        <i data-lucide="target" class="w-3 h-3"></i> The Main Goal
                    </h4>
                    <p id="drawer-purpose" class="text-sm text-gray-300 leading-relaxed font-medium"></p>
                </section>

                <section id="drawer-constraints-section" class="hidden">
                    <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                        <i data-lucide="alert-circle" class="w-3 h-3"></i> System Constraints
                    </h4>
                    <div id="drawer-constraints" class="flex flex-wrap gap-2"></div>
                </section>

                <section>
                    <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                        <i data-lucide="terminal" class="w-3 h-3"></i> Logic Loop
                    </h4>
                    <div id="drawer-logic" class="bg-black/40 border border-white/5 rounded-xl p-5 text-xs text-gray-300 leading-relaxed mono whitespace-pre-wrap border-l-2 border-l-blue-500/50"></div>
                </section>

                <div class="bg-gray-900/50 p-5 rounded-2xl border border-white/5">
                    <h4 class="text-[10px] font-bold text-amber-500 uppercase mb-3">The Stack</h4>
                    <div id="drawer-tools" class="flex flex-wrap gap-2"></div>
                </div>

                <section class="pb-10">
                    <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">Execution Trace</h4>
                    <div class="space-y-4">
                        <div class="bg-black/60 rounded-xl border border-blue-500/20 overflow-hidden">
                            <div class="bg-blue-500/10 px-3 py-1.5 border-b border-blue-500/20 flex justify-between items-center">
                                <span class="text-[9px] font-bold text-blue-400 mono uppercase tracking-widest">Input</span>
                                <i data-lucide="arrow-right-circle" class="w-3 h-3 text-blue-400 opacity-50"></i>
                            </div>
                            <pre id="drawer-input" class="p-4 text-[10px] text-blue-300/80 overflow-x-auto mono"></pre>
                        </div>
                        <div class="bg-black/60 rounded-xl border border-purple-500/20 overflow-hidden">
                            <div class="bg-purple-500/10 px-3 py-1.5 border-b border-purple-500/20 flex justify-between items-center">
                                <span class="text-[9px] font-bold text-purple-400 mono uppercase tracking-widest">Output</span>
                                <i data-lucide="check-circle" class="w-3 h-3 text-purple-400 opacity-50"></i>
                            </div>
                            <pre id="drawer-output" class="p-4 text-[10px] text-purple-300/80 overflow-x-auto mono"></pre>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Global Design Principles Footer -->
        <footer class="p-3 bg-gray-900 border-t border-gray-800 flex justify-center space-x-6 md:space-x-12 z-20 overflow-x-auto whitespace-nowrap scrollbar-hide">
            <div class="flex items-center space-x-2 text-[7px] md:text-[8px] font-black uppercase tracking-widest text-gray-600">
                <i data-lucide="database" class="w-3 h-3 text-amber-500/50"></i>
                <span>Truth vs Event</span>
            </div>
            <div class="flex items-center space-x-2 text-[7px] md:text-[8px] font-black uppercase tracking-widest text-gray-600">
                <i data-lucide="user-check" class="w-3 h-3 text-amber-500/50"></i>
                <span>Human in Loop</span>
            </div>
            <div class="flex items-center space-x-2 text-[7px] md:text-[8px] font-black uppercase tracking-widest text-gray-600">
                <i data-lucide="eye" class="w-3 h-3 text-amber-500/50"></i>
                <span>Observability</span>
            </div>
            <div class="flex items-center space-x-2 text-[7px] md:text-[8px] font-black uppercase tracking-widest text-gray-600">
                <i data-lucide="shield" class="w-3 h-3 text-amber-500/50"></i>
                <span>Fail Closed</span>
            </div>
        </footer>
    </main>

    <script>
        const scenarioData = {
            'mother-ai': {
                title: "Mother AI Orchestrator",
                intent: "Recursive Cognitive Layer",
                summary: "The central intelligence that learns from its own reflections. Features a dual-persistence memory model and a conversational 'Echo' agent for meta-cognitive oversight.",
                executive: {
                    problem: "Creative projects suffer from 'context drift' where daily tasks lose alignment with the vision, leading to inefficient development cycles.",
                    solution: "A recursive AI orchestrator that transforms passive file events into active reflection loops, syncing local insights into a global knowledge bank.",
                    result: "Achieved a 60% reduction in manual status tracking and preserved 90%+ context accuracy across multi-week builds.",
                    value: "Transforms raw data into institutional knowledge. Every technical lesson learned is automatically codified without human overhead.",
                    kpis: [["Accuracy", "92%"], ["Overhead", "-60%"], ["Latency", "<2s"], ["State", "Prod"]],
                    restraint: "Automation is limited to metadata and goal-tracking. requires manual confirmation for code writes to preserve architectural integrity."
                },
                nodes: [
                    { id: 'm1', x: 100, y: 300, type: 'Input', name: 'Event Listener', icon: 'eye', purpose: 'Detects systemic changes and logs.', logic: 'Summarizes history to optimize context window for LLMs.', metaphor: 'A watchman at the gate, writing down everything in a notebook.', input: 'Git Diff: modified app_controller.py', output: 'Context: Summarized Data', tools: ['Python', 'Git API'], constraints: ['File IO speed', 'Git repository access'] },
                    { id: 'm2', x: 400, y: 300, type: 'Core', name: 'Mother Core', icon: 'cpu', purpose: 'Central logic engine that handles orchestration.', logic: 'Directs all traffic. Manages frame transitions and global styling.', metaphor: 'The Librarian who knows where every book is.', input: 'Context: Summarized Data', output: 'Action: Trigger Reflection', tools: ['Python', 'Tkinter'], designNote: 'Decoupled from actual file ops to prevent accidental corruption during orchestration.', constraints: ['Context window (128k)', 'API cost caps'] },
                    { id: 'm3', x: 700, y: 300, type: 'Memory', name: 'Project Memory', icon: 'save', purpose: 'Local learning layer for project context.', logic: 'Stores local reflection logs and project-specific scores.', metaphor: 'The specific notebook for just this project.', input: 'Reflection Data', output: 'Local State: Updated', tools: ['PyYAML'], designNote: 'Uses YAML over SQL for local storage to allow human-readable debugging of AI thoughts.', constraints: ['100KB file limit'] },
                    { id: 'm4', x: 700, y: 100, type: 'Agent', name: 'Echo Engine', icon: 'message-circle', purpose: 'Conversational unit for meta-oversight.', logic: 'Adjusts behavior based on accumulated insights.', metaphor: 'The personal assistant who talks you through the plan.', input: 'Goal: Optimize Memory', output: 'Advice: Compress YAML files', tools: ['Gemini 1.5'] },
                    { id: 'm5', x: 1000, y: 100, type: 'Gateway', name: 'Zapier Gateway', icon: 'zap', purpose: 'External synchronization.', logic: 'Syncs project events to external CRM or Slack via webhooks.', metaphor: 'The diplomat sending letters to other kingdoms.', input: 'Event: Milestone', output: 'External: Success', tools: ['Zapier', 'Webhooks'] },
                    { id: 'm6', x: 1000, y: 300, type: 'Global', name: 'World Memory', icon: 'database', purpose: 'Global knowledge bank.', logic: 'Stabilization rules: Insights become STABLE after 5 reinforcements.', metaphor: 'The Master Encyclopedia that never forgets life lessons.', input: 'Insight: API failure', output: 'Heuristic: Add delay', tools: ['PostgreSQL'], designNote: 'Authoritative source for cross-project heuristics.' }
                ],
                edges: [['m1', 'm2'], ['m2', 'm3'], ['m2', 'm4'], ['m4', 'm5'], ['m3', 'm6'], ['m5', 'm6']]
            },
            'zapier-debug': {
                title: "Failed Payment Debug",
                intent: "Customer Trust Hotfix",
                summary: "Fixes a critical 'Stale Data' bug in payment reminders. Features a Step 11.5 CRM Lookup and a perfected two-rule filter logic to ensure only unpaid leads receive follow-ups.",
                executive: {
                    problem: "Paid customers were receiving erroneous payment-failure emails because automation relied on Stripe's stale initial failure trigger.",
                    solution: "Pivoted from 'Event-Led' to 'Source-of-Truth' architecture. Added a mandatory 24h delay followed by a forced CRM status refresh (Step 11.5).",
                    result: "100% elimination of erroneous emails. Restored brand integrity and reduced support volume by 40%.",
                    value: "Prevents brand damage. A single misfired 'Unpaid' email destroys high-ticket relationships; this logic prevents that.",
                    kpis: [["Error Rate", "0%"], ["Tickets", "-40%"], ["Verify", "2-Step"], ["Status", "Hotfix"]],
                    restraint: "Fail-Closed: If CRM API is unresponsive, automation halts rather than risk misfiring an email to a potentially paid customer."
                },
                nodes: [
                    { id: 'z1', x: 150, y: 300, type: 'Trigger', name: 'Stripe Failed Event', icon: 'zap', purpose: 'Captures initial failure signal.', logic: 'Captures charge ID. Data is treated as non-authoritative.', metaphor: 'Taking a snapshot of a moving train.', input: '{"status": "failed"}', output: '{"status": "failed"}', tools: ['Stripe'], designNote: 'Treating the trigger as a "Signal" rather than "Truth" is the core fix.' },
                    { id: 'z2', x: 450, y: 300, type: 'Delay', name: '24-Hour Buffer', icon: 'clock', purpose: 'Allow window for retry.', logic: 'Essential friction to allow customer self-correction.', metaphor: 'Putting a letter in the "Outbox" for the morning.', input: '{"delay": "24h"}', output: '{"status": "resumed"}', tools: ['Zapier'], designNote: 'Essential friction: Reduces support tickets by 40%.' },
                    { id: 'z3', x: 750, y: 300, type: 'Lookup', name: 'CRM Live Sync', icon: 'search', purpose: 'Refresh Source of Truth.', logic: 'Querying Visa CRM directly for "Deal Status".', metaphor: 'Looking out the window to see where the train is now.', input: '{"email": "user@...com"}', output: '{"Status": "Deal won!"}', tools: ['CRM API'], designNote: 'Bypasses the stale data from Step 1.' },
                    { id: 'z4', x: 1050, y: 300, type: 'Router', name: 'Precision Filter', icon: 'filter', purpose: 'Deterministic halt gate.', logic: 'Halt if CRM Status == "Deal won!".', metaphor: 'Checking both the passenger ID and the ticket status.', input: '{"Status": "Deal won!"}', output: 'HALT (VALID FIX)', tools: ['Filter'], designNote: 'Fail-closed logic.' },
                    { id: 'z5', x: 1350, y: 300, type: 'Action', name: 'Follow-up Email', icon: 'mail', purpose: 'Re-engage customer.', logic: 'Sends personalized email only if Filter passes.', metaphor: 'Delivering the letter after confirmation.', input: 'unpaid', output: 'Email Sent', tools: ['Gmail API'] }
                ],
                edges: [['z1', 'z2'], ['z2', 'z3'], ['z3', 'z4'], ['z4', 'z5']]
            },
            'ai-validation': {
                title: "AI Validation Flow",
                intent: "Semantic Data Hygiene",
                summary: "A robust lead quality gate that uses semantic validation to filter out spam and deceptive data, ensuring 96%+ CRM hygiene.",
                executive: {
                    problem: "Unprotected webhooks are a magnet for spam and bot-generated leads, resulting in 'Ghost Leads' that waste agent time.",
                    solution: "A semantic 'Air-Lock' gate. Before any lead enters the CRM, an LLM performs a focus check to ensure the intent is professional.",
                    result: "Zero spam records in the primary CRM since deployment. 98% detection rate of deceptive lead entries.",
                    value: "Guaranteed Data Integrity. Agents only ever see verified, high-intent prospects, allowing them to focus on conversion.",
                    kpis: [["Detection", "98%"], ["Hygiene", "100%"], ["Latency", "1.2s"], ["Status", "Live"]],
                    restraint: "Fail-Closed: If the validation AI is uncertain, the lead is diverted to an 'Isolation Log' for manual review."
                },
                nodes: [
                    { id: 'v1', x: 100, y: 300, type: 'Trigger', name: 'Webhook Ingest', icon: 'zap', purpose: 'Intake raw data.', logic: 'Treats all data as untrusted until validated.', metaphor: 'Mailbox catching letters.', input: 'name: Ky', output: 'raw_data', tools: ['Make'] },
                    { id: 'v2', x: 400, y: 300, type: 'AI Agent', name: 'Gemini Gatekeeper', icon: 'shield-check', purpose: 'Semantic validation.', logic: 'Returns failure codes for non-professional input.', metaphor: 'Inspector tossing out dented cans.', input: 'about: crypto', output: 'valid: false', tools: ['Gemini'], designNote: 'Hardened prompt returns deterministic success codes for pass/fail.' },
                    { id: 'v3', x: 700, y: 300, type: 'Router', name: 'Decision Gate', icon: 'git-branch', purpose: 'Path selection.', logic: 'Routes data based on AI success code.', metaphor: 'Traffic light for inspected cars.', input: 'valid: false', output: 'Route: Fallback', tools: ['Logic'] },
                    { id: 'v4', x: 1000, y: 100, type: 'Action', name: 'CRM Success', icon: 'check-circle', purpose: 'Final data storage.', logic: 'Logs enriched data to primary CRM.', metaphor: 'Putting the perfect apple on the shelf.', input: 'valid: true', output: 'CRM: Updated', tools: ['Salesforce'] },
                    { id: 'v5', x: 1250, y: 100, type: 'Action', name: 'Slack Alert', icon: 'slack', purpose: 'Instant notification.', logic: 'Sends alert with lead context.', metaphor: 'Ringing the victory bell.', input: 'Updated', output: 'Slack: Sent', tools: ['Slack'] },
                    { id: 'v6', x: 1000, y: 450, type: 'Action', name: 'Fallback: Log', icon: 'alert-triangle', purpose: 'Integrity fallback.', logic: 'Logs raw input for manual review.', metaphor: 'The "Lost and Found" box.', input: 'fail: junk', output: 'logged: true', tools: ['PostgreSQL'] }
                ],
                edges: [['v1', 'v2'], ['v2', 'v3'], ['v3', 'v4'], ['v4', 'v5'], ['v3', 'v6']]
            },
            'attorney': {
                title: "Attorney Pipeline v2.0",
                intent: "Regional Acquisition",
                summary: "Qualifies legal leads at scale using a 3-Phase approach with a Google Sheets buffer for stability and a 5-layer weighted dedupe logic.",
                executive: {
                    problem: "Direct web-scraping into CRMs creates data poisoning and high API costs due to ingestion of non-relevant profiles.",
                    solution: "A 'Buffered Phase' architecture. Data is staged in Sheets for audit before passing through weighted 5-layer Python dedupe and Gemini classifier.",
                    result: "96% lead accuracy and 50% reduction in scraping costs by replacing indiscriminate scraping with manual triggers.",
                    value: "Cost-efficient scaling. Team can scout regions while only paying for qualified data ingestion.",
                    kpis: [["Accuracy", "96%"], ["Cost", "-50%"], ["Dedupe", "5-Layer"], ["Batch", "25"]],
                    restraint: "Triggering is manual to ensure credits are only spent on territories verified by the legal team."
                },
                nodes: [
                    { id: 'at1', x: 100, y: 300, type: 'Trigger', name: 'Notion Trigger', icon: 'zap', purpose: 'Manual activation.', logic: 'Webhook initiation on-demand.', metaphor: 'Turning on the tap.', input: 'START', output: 'SCOUTING', tools: ['Notion'], designNote: 'Intentionally manual to control costs.' },
                    { id: 'at2', x: 400, y: 300, type: 'Scout', name: 'Relevance Scout', icon: 'search', purpose: 'Web acquisition.', logic: 'Searches Google and sites. Extracting Firm/Email.', metaphor: 'Assistant scanning phone books.', input: 'Immigration', output: 'profiles: 25', tools: ['Relevance AI'] },
                    { id: 'at3', x: 700, y: 300, type: 'Queue', name: 'GSheets Buffer', icon: 'layers', purpose: 'Stability intermediary.', logic: 'Intermediary queue to eliminate unstable direct connections.', metaphor: 'A cargo check area.', input: 'batch: 25', output: 'BUFFERED', tools: ['GSheets'], designNote: 'Decoupling: Protects Notion API.' },
                    { id: 'at4', x: 1000, y: 300, type: 'Logic', name: '5-Layer Dedupe', icon: 'filter', purpose: 'Weighted detection.', logic: 'Checks Name, Email, Firm, Web, and Phone.', metaphor: 'Security guard checking fingerprints.', input: 'kyle@legal.com', output: 'unique: true', tools: ['Python'], constraints: ['Notion 3 req/s limit'] },
                    { id: 'at5', x: 1300, y: 300, type: 'Phase 2', name: 'Gemini Classifier', icon: 'shield-check', purpose: 'Immigration focus grade.', logic: 'Grades leads: HIGH / MEDIUM / LOW focus.', metaphor: 'Sorting mail into important vs junk.', input: 'EB-1A Practice', output: 'focus: HIGH', tools: ['Gemini'] },
                    { id: 'at6', x: 1600, y: 300, type: 'Phase 3', name: 'GPT-4o Drafter', icon: 'pen-tool', purpose: 'Email personalization.', logic: 'Creates customized drafts based on lead focus.', metaphor: 'Ghostwriter drafting a reply.', input: 'lead: HIGH', output: 'draft: Hello...', tools: ['OpenAI'] }
                ],
                edges: [['at1', 'at2'], ['at2', 'at3'], ['at3', 'at4'], ['at4', 'at5'], ['at5', 'at6']]
            },
            'helpscout': {
                title: "Help Scout Sage",
                intent: "Agent Efficiency multiplier",
                summary: "High-performance AI Draft Generator for customer support agents. Features multi-step intent profiling and tone optimization to ensure human-like drafts.",
                executive: {
                    problem: "Routine support tickets consume 40% of agent bandwidth, slowing down the response time for complex technical issues.",
                    solution: "A context-aware AI Co-pilot. The system generates a personalized, brand-voice response as an 'Internal Note' for review.",
                    result: "60% reduction in initial response drafting time. Achieved high agent adoption by keeping the human in the loop.",
                    value: "Scaling support without headcount. Agents can handle 2x the volume while maintaining high empathy.",
                    kpis: [["Drafting", "-60%"], ["Accuracy", "95%"], ["Adoption", "85%"], ["Status", "Live"]],
                    restraint: "AI drafts are never sent directly to the customer. They are strictly 'Draft-Only' internal notes."
                },
                nodes: [
                    { id: 'hs1', x: 100, y: 300, type: 'Trigger', name: 'Sidebar Trigger', icon: 'mouse-pointer-2', purpose: 'Agent activated request.', logic: 'Sidebar app sends conversation ID.', metaphor: 'Ringing the bell for help.', input: 'id: 3107', output: 'SAGE_CALL', tools: ['Vanilla JS'], designNote: 'Ensures AI remains an assistant.' },
                    { id: 'hs2', x: 400, y: 300, type: 'Context', name: 'Context Fetcher', icon: 'file-search', purpose: 'Fetch thread history.', logic: 'Retrieves all threads via HS API.', metaphor: 'Assistant reading old letters.', input: 'id: 3107', output: 'threads: [...]', tools: ['Node.js', 'HS API'] },
                    { id: 'hs3', x: 700, y: 300, type: 'Intelligence', name: 'Intent Profiler', icon: 'brain-circuit', purpose: 'Categorization.', logic: 'Sentiment and intent analysis.', metaphor: 'Reading the room.', input: 'msg: Refund?', output: 'intent: billing', tools: ['Gemini'] },
                    { id: 'hs4', x: 1000, y: 300, type: 'AI Agent', name: 'Sage Engine', icon: 'sparkles', purpose: 'Draft generation.', logic: 'Creates draft based on guidelines.', metaphor: 'Ghostwriter drafting a response.', input: 'intent: billing', output: 'draft: Hello...', tools: ['Gemini'] },
                    { id: 'hs5', x: 1300, y: 300, type: 'Quality', name: 'Tone & Polish', icon: 'check-check', purpose: 'Brand voice check.', logic: 'Format and tone optimization.', metaphor: 'Proofreader checking the draft.', input: 'draft: ...', output: 'final: ...', tools: ['OpenAI'] },
                    { id: 'hs6', x: 1600, y: 300, type: 'Action', name: 'Note Injection', icon: 'send', purpose: 'Post internal note.', logic: 'Posts draft as a Private Note.', metaphor: 'Placing a sticky note on a file.', input: 'final: ...', output: 'SUCCESS', tools: ['HS API'] }
                ],
                edges: [['hs1', 'hs2'], ['hs2', 'hs3'], ['hs3', 'hs4'], ['hs4', 'hs5'], ['hs5', 'hs6']]
            }
        };

        let currentActiveView = 'architect';
        let activeScenario = 'mother-ai';
        let isSimulating = false;
        let isTerminalActive = false;
        let isMobileMenuOpen = false;

        function toggleMobileMenu() {
            isMobileMenuOpen = !isMobileMenuOpen;
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (isMobileMenuOpen) {
                sidebar.classList.add('open');
                overlay.classList.remove('hidden-overlay');
                overlay.classList.add('visible');
            } else {
                sidebar.classList.remove('open');
                overlay.classList.remove('visible');
                overlay.classList.add('hidden-overlay');
            }
        }

        function setViewMode(mode) {
            currentActiveView = mode;
            document.querySelectorAll('.toggle-btn').forEach(b => {
                b.classList.remove('active');
                b.classList.add('text-gray-500');
            });
            const activeBtn = document.getElementById(`mode-${mode}`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.classList.remove('text-gray-500');
            }
            
            if (mode === 'architect') {
                document.getElementById('view-architect').classList.remove('hidden');
                document.getElementById('view-executive').classList.add('hidden');
            } else {
                document.getElementById('view-architect').classList.add('hidden');
                document.getElementById('view-executive').classList.remove('hidden');
                renderExecutiveView();
            }
        }

        function renderExecutiveView() {
            const s = scenarioData[activeScenario];
            if (!s) return;
            document.getElementById('exec-title').innerText = s.title;
            document.getElementById('exec-intent').innerText = s.intent;
            document.getElementById('exec-problem').innerText = s.executive.problem;
            document.getElementById('exec-solution').innerText = s.executive.solution;
            document.getElementById('exec-result').innerText = s.executive.result;
            document.getElementById('exec-restraint').innerText = s.executive.restraint;
            document.getElementById('exec-value').innerText = s.executive.value;
            
            const kpiContainer = document.getElementById('exec-kpis');
            kpiContainer.innerHTML = s.executive.kpis.map(k => `
                <div class="text-center group">
                    <div class="text-[8px] md:text-[9px] font-black text-gray-600 uppercase mb-1 md:mb-2 tracking-[0.2em] group-hover:text-amber-500/50 transition-colors">${k[0]}</div>
                    <div class="text-lg md:text-3xl font-black text-white group-hover:scale-110 transition-transform cursor-default">${k[1]}</div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function addLog(message, type = 'info') {
            const container = document.getElementById('log-container');
            if (!container) return;
            const log = document.createElement('div');
            const time = new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            if (type === 'success') log.className = "text-green-400";
            else if (type === 'process') log.className = "text-amber-400 font-bold";
            else if (type === 'system') log.className = "text-blue-400";
            else if (type === 'error') log.className = "text-red-400 font-bold";
            log.innerHTML = `<span class="opacity-20 mr-2 tracking-tighter">${time}</span> ${message}`;
            container.appendChild(log);
            container.scrollTop = container.scrollHeight;
        }

        function toggleTerminal(force) {
            const terminal = document.getElementById('live-terminal');
            const btn = document.getElementById('term-btn');
            
            if (force !== undefined) isTerminalActive = force;
            else isTerminalActive = !isTerminalActive;

            if (isTerminalActive) {
                terminal.style.opacity = '1'; 
                terminal.classList.remove('pointer-events-none', 'translate-y-10');
                if (btn) btn.classList.add('bg-amber-500/10', 'border-amber-500/50', 'text-amber-500');
            } else {
                terminal.style.opacity = '0'; 
                terminal.classList.add('pointer-events-none', 'translate-y-10');
                if (btn) btn.classList.remove('bg-amber-500/10', 'border-amber-500/50', 'text-amber-500');
            }
        }

        function loadScenario(id) {
            if (isSimulating) stopSimulation();
            const data = scenarioData[id];
            if (!data) {
                addLog(`ERROR: Scenario data for '${id}' not found.`, 'error');
                return;
            }
            activeScenario = id;
            if (isMobileMenuOpen) toggleMobileMenu();
            
            document.getElementById('scenario-title').innerText = data.title;
            document.querySelectorAll('nav button').forEach(btn => {
                btn.className = "w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 text-sm font-medium flex items-center justify-between transition-all group";
            });
            const activeBtn = document.getElementById(`btn-${id}`);
            if(activeBtn) activeBtn.className = "w-full text-left px-4 py-3 rounded-lg bg-amber-500/10 border border-amber-500/50 text-amber-500 text-sm font-bold flex items-center justify-between group";
            
            if (currentActiveView === 'executive') renderExecutiveView();
            renderCanvas();
            addLog(`CONTEXT SWITCH: ${data.title}`, 'system');
        }

        function renderCanvas() {
            const data = scenarioData[activeScenario];
            if (!data) return;
            const nodeLayer = document.getElementById('node-layer');
            const svgLayer = document.getElementById('svg-layer');
            nodeLayer.innerHTML = ''; svgLayer.innerHTML = '';
            
            data.edges.forEach((edge, idx) => {
                const source = data.nodes.find(n => n.id === edge[0]);
                const target = data.nodes.find(n => n.id === edge[1]);
                if (!source || !target) return;
                const x1 = source.x + 192, y1 = source.y + 70, x2 = target.x, y2 = target.y + 70;
                const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
                line.setAttribute("d", `M ${x1} ${y1} C ${x1 + (x2-x1)/2} ${y1}, ${x1 + (x2-x1)/2} ${y2}, ${x2} ${y2}`);
                line.setAttribute("id", `path-${activeScenario}-${idx}`);
                line.setAttribute("stroke", "#1f2937"); line.setAttribute("stroke-width", "2");
                line.setAttribute("fill", "none"); line.setAttribute("class", "line-flow");
                svgLayer.appendChild(line);
            });
            
            data.nodes.forEach(node => {
                const div = document.createElement('div');
                div.id = `node-${node.id}`;
                div.className = "absolute node-card w-48 p-4 rounded-xl cursor-pointer shadow-xl z-10 flex flex-col h-[140px]";
                div.style.left = `${node.x}px`; div.style.top = `${node.y}px`;
                div.onclick = () => openDrawer(node);
                div.innerHTML = `<div class="glow-pulse"></div><span class="text-[9px] font-black text-gray-500 uppercase tracking-widest mb-2">${node.type}</span><div class="flex items-center space-x-3 mb-4"><div class="p-2 bg-gray-800 rounded-lg"><i data-lucide="${node.icon}" class="w-5 h-5"></i></div><h4 class="text-xs font-bold text-white leading-tight">${node.name}</h4></div>`;
                nodeLayer.appendChild(div);
            });
            lucide.createIcons();
        }

        async function startSimulation() {
            if (isSimulating) return;
            if (currentActiveView !== 'architect') setViewMode('architect');
            isSimulating = true;
            toggleTerminal(true);
            
            const inputVal = document.getElementById('terminal-input').value.toLowerCase();
            const isChaos = ['fail', 'won', 'spam', 'crypto'].some(k => inputVal.includes(k));
            
            addLog(`INITIATING: ${isChaos ? '[CHAOS_DIAGNOSTIC]' : '[SYSTEM_TRACE]'}`, 'process');
            const data = scenarioData[activeScenario];
            if (!data) return;
            const svgLayer = document.getElementById('svg-layer');
            const packet = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            packet.setAttribute("r", "5"); packet.setAttribute("class", "data-packet" + (isChaos ? " error-packet" : ""));
            svgLayer.appendChild(packet);

            for (let i = 0; i < data.edges.length; i++) {
                if (!isSimulating) break;
                const edge = data.edges[i];
                const sourceNode = data.nodes.find(n => n.id === edge[0]);
                const targetNode = data.nodes.find(n => n.id === edge[1]);
                const path = document.getElementById(`path-${activeScenario}-${i}`);
                
                if (sourceNode) {
                    const nodeEl = document.getElementById(`node-${sourceNode.id}`);
                    if (nodeEl) {
                        nodeEl.classList.add('processing');
                        openDrawer(sourceNode);
                        addLog(`[EXEC] ${sourceNode.name}`, 'process');
                    }
                    await new Promise(r => setTimeout(r, 600));
                    
                    if (isChaos && (sourceNode.id === 'z4' || sourceNode.id === 'v3' || sourceNode.id === 'v2')) {
                        addLog(`[HALT] Safety gate triggered.`, 'error');
                        if (nodeEl) {
                            nodeEl.classList.add('failed');
                            nodeEl.classList.remove('processing');
                        }
                        break;
                    }
                    if (nodeEl) nodeEl.classList.remove('processing');
                }
                
                if (path) {
                    const length = path.getTotalLength();
                    const start = performance.now();
                    await new Promise(resolve => {
                        function animate(time) {
                            if (!isSimulating) return resolve();
                            const p = Math.min((time - start) / 600, 1);
                            const pt = path.getPointAtLength(p * length);
                            packet.setAttribute("cx", pt.x); packet.setAttribute("cy", pt.y);
                            if (p < 1) requestAnimationFrame(animate); else resolve();
                        }
                        requestAnimationFrame(animate);
                    });
                }

                if (i === data.edges.length - 1 && targetNode) {
                     const finalNodeEl = document.getElementById(`node-${targetNode.id}`);
                     if (finalNodeEl) {
                        finalNodeEl.classList.add('processing');
                        openDrawer(targetNode);
                        addLog(`[FINAL] ${targetNode.name}: Terminal.`, 'success');
                     }
                     await new Promise(r => setTimeout(r, 600));
                     if (finalNodeEl) finalNodeEl.classList.remove('processing');
                }
            }
            stopSimulation();
        }

        function stopSimulation() {
            isSimulating = false;
            document.querySelectorAll('.data-packet').forEach(p => p.remove());
            document.querySelectorAll('.node-card').forEach(n => n.classList.remove('processing', 'failed'));
            addLog(`TRACE COMPLETE.`, 'system');
        }

        function openDrawer(node, customInput = null) {
            const drawerName = document.getElementById('drawer-name');
            if (!drawerName) return;
            
            drawerName.innerText = node.name;
            document.getElementById('drawer-type').innerText = node.type;
            document.getElementById('drawer-logic').innerText = node.logic;
            document.getElementById('drawer-metaphor').innerText = node.metaphor;
            document.getElementById('drawer-purpose').innerText = node.purpose || "Primary objective of this system step.";
            document.getElementById('drawer-input').innerText = customInput || node.input;
            document.getElementById('drawer-output').innerText = node.output || "No output samples defined.";
            document.getElementById('drawer-tools').innerHTML = (node.tools || []).map(t => `<span class="px-2 py-1 bg-white/5 rounded text-[10px] text-gray-400 font-bold border border-white/5 uppercase">${t}</span>`).join('');
            document.getElementById('drawer-icon').innerHTML = `<i data-lucide="${node.icon}" class="w-8 h-8"></i>`;
            
            const whySec = document.getElementById('drawer-why-section');
            if (node.designNote) {
                document.getElementById('drawer-design-note').innerText = node.designNote;
                whySec.classList.remove('hidden');
            } else whySec.classList.add('hidden');

            const conSec = document.getElementById('drawer-constraints-section');
            if (node.constraints && node.constraints.length > 0) {
                document.getElementById('drawer-constraints').innerHTML = node.constraints.map(c => `<span class="px-2 py-1 bg-white/5 border border-white/5 rounded text-[8px] font-bold text-gray-500 uppercase tracking-widest">${c}</span>`).join('');
                conSec.classList.remove('hidden');
            } else conSec.classList.add('hidden');

            document.getElementById('drawer').classList.remove('translate-x-full'); 
            lucide.createIcons();
        }

        function closeDrawer() { document.getElementById('drawer').classList.add('translate-x-full'); }

        window.onload = () => {
            loadScenario('mother-ai');
            lucide.createIcons();
        };

        document.getElementById('terminal-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const val = this.value.trim();
                if (!val) return;
                addLog(`INJECTED: "${val}"`, 'process');
                startSimulation();
                this.value = '';
            }
        });
    </script>
</body>
</html>
