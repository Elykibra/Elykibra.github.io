<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kyle Tolilic - Automation Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b0f1a;
            color: #E5E7EB;
            overflow: hidden;
        }
        .canvas-grid {
            background-image: radial-gradient(#2d3748 1px, transparent 1px);
            background-size: 30px 30px;
        }
        .node-card {
            background: rgba(31, 41, 55, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid #374151;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .node-card.processing {
            border-color: #FBBF24;
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.2);
            transform: translateY(-4px) scale(1.02);
        }
        .node-card.failed {
            border-color: #EF4444;
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.2);
        }
        .line-flow {
            stroke-dasharray: 8;
            animation: flow 30s linear infinite;
        }
        @keyframes flow {
            from { stroke-dashoffset: 500; }
            to { stroke-dashoffset: 0; }
        }
        .data-packet {
            fill: #FBBF24;
            filter: drop-shadow(0 0 8px #FBBF24);
            transition: fill 0.3s;
        }
        .data-packet.error-packet {
            fill: #EF4444;
            filter: drop-shadow(0 0 8px #EF4444);
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        .console-scrollbar::-webkit-scrollbar { width: 4px; }
        .console-scrollbar::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
        
        #terminal-input:focus { outline: none; }
        .cursor-blink { animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        .ai-response {
            border-left: 3px solid #FBBF24;
            background: linear-gradient(to right, rgba(251, 191, 36, 0.05), transparent);
            animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .glow-pulse {
            position: absolute;
            inset: -2px;
            border-radius: 0.75rem;
            background: linear-gradient(45deg, #FBBF24, transparent, #FBBF24);
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s;
        }
        .processing .glow-pulse {
            opacity: 0.4;
            animation: rotateGlow 2s linear infinite;
        }
        @keyframes rotateGlow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased h-screen flex flex-col md:flex-row">

    <!-- Left Sidebar -->
    <aside class="w-full md:w-80 bg-gray-900 border-r border-gray-800 p-6 flex flex-col h-full z-30">
        <div class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-black text-white tracking-tight uppercase">Kyle Tolilic</h1>
                <p class="text-amber-500 font-bold text-xs mt-1 uppercase tracking-widest">Automation Architect</p>
            </div>
        </div>

        <nav class="space-y-6 flex-grow overflow-y-auto">
            <div>
                <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 text-center md:text-left">Intelligence Systems</h3>
                <div class="space-y-2">
                    <button onclick="loadScenario('mother-ai')" id="btn-mother-ai" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 border border-transparent text-gray-400 text-sm font-medium flex items-center justify-between transition-all group">
                        <span>Mother AI Orchestrator</span>
                        <i data-lucide="cpu" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <div>
                <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 text-center md:text-left">Game Systems</h3>
                <div class="space-y-2">
                    <button onclick="loadScenario('aethelgard')" id="btn-aethelgard" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 border border-transparent text-gray-400 text-sm font-medium flex items-center justify-between transition-all group">
                        <span>Aethelgard RPG</span>
                        <i data-lucide="gamepad-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <div>
                <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 text-center md:text-left">Diagnostic Reports</h3>
                <div class="space-y-2">
                    <button onclick="loadScenario('zapier-debug')" id="btn-zapier-debug" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 border border-transparent text-gray-400 text-sm font-medium flex items-center justify-between transition-all group">
                        <span>Failed Payment Debug</span>
                        <i data-lucide="bug" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <div>
                <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 text-center md:text-left">Built Scenarios</h3>
                <div class="space-y-2">
                    <button onclick="loadScenario('attorney')" id="btn-attorney" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 border border-transparent text-gray-400 text-sm font-medium flex items-center justify-between transition-all group">
                        <span>Attorney Pipeline v2.0</span>
                        <i data-lucide="briefcase" class="w-4 h-4"></i>
                    </button>
                    <button onclick="loadScenario('helpscout')" id="btn-helpscout" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 border border-transparent text-gray-400 text-sm font-medium flex items-center justify-between transition-all group">
                        <span>Help Scout Sage</span>
                        <i data-lucide="message-square" class="w-4 h-4"></i>
                    </button>
                    <button onclick="loadScenario('ai-validation')" id="btn-ai-validation" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 border border-transparent text-gray-400 text-sm font-medium flex items-center justify-between transition-all group">
                        <span>AI Validation Flow</span>
                        <i data-lucide="shield-check" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <div class="pt-6 border-t border-gray-800 space-y-4">
                <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1">Connect</h3>
                <a href="mailto:ktolilic@gmail.com" class="flex items-center space-x-3 text-sm text-gray-400 hover:text-amber-500 transition-colors">
                    <i data-lucide="mail" class="w-4 h-4"></i>
                    <span>ktolilic@gmail.com</span>
                </a>
                <a href="https://github.com/Elykibra" target="_blank" class="flex items-center space-x-3 text-sm text-gray-400 hover:text-amber-500 transition-colors">
                    <i data-lucide="github" class="w-4 h-4"></i>
                    <span>Elykibra</span>
                </a>
                <a href="https://www.linkedin.com/in/kyle-tolilic" target="_blank" class="flex items-center space-x-3 text-sm text-gray-400 hover:text-amber-500 transition-colors">
                    <i data-lucide="linkedin" class="w-4 h-4"></i>
                    <span>LinkedIn</span>
                </a>
                <a href="https://www.behance.net/kyle_tolilic" target="_blank" class="flex items-center space-x-3 text-sm text-gray-400 hover:text-amber-500 transition-colors">
                    <i data-lucide="palette" class="w-4 h-4"></i>
                    <span>Behance</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Workspace -->
    <main class="flex-grow relative overflow-hidden flex flex-col bg-[#0b0f1a]">
        <header class="p-4 bg-gray-900/50 backdrop-blur-md border-b border-gray-800 flex justify-between items-center z-20">
            <div class="flex items-center space-x-4">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse" id="status-pulse"></div>
                <h2 id="scenario-title" class="text-sm font-bold text-white uppercase tracking-wider">Scenario Name</h2>
                
                <div class="h-6 w-px bg-gray-800 mx-2 hidden sm:block"></div>
                <div class="flex items-center space-x-2">
                    <button onclick="startSimulation()" id="sim-btn" class="flex items-center space-x-2 px-3 py-1 bg-amber-500/10 border border-amber-500/50 rounded-full text-amber-500 text-[10px] font-black uppercase tracking-widest hover:bg-amber-500 hover:text-gray-900 transition-all">
                        <i data-lucide="play" class="w-3 h-3"></i>
                        <span>Run Simulation</span>
                    </button>
                    <button onclick="toggleTerminal()" id="term-toggle-btn" class="flex items-center space-x-2 px-3 py-1 bg-gray-800 border border-gray-700 rounded-full text-gray-400 text-[10px] font-black uppercase tracking-widest hover:border-amber-500/50 hover:text-white transition-all">
                        <i data-lucide="terminal" class="w-3 h-3"></i>
                        <span>Console</span>
                    </button>
                </div>
            </div>
        </header>

        <div id="canvas-container" class="flex-grow canvas-grid relative overflow-auto cursor-grab active:cursor-grabbing">
            <div class="relative w-[2400px] h-[1200px]">
                <svg id="svg-layer" class="absolute top-0 left-0 w-full h-full pointer-events-none z-0"></svg>
                <div id="node-layer" class="absolute top-0 left-0 w-full h-full z-10"></div>
            </div>

            <!-- Live Terminal -->
            <div id="live-terminal" class="absolute bottom-6 left-6 right-6 h-56 bg-black/95 backdrop-blur-xl border border-white/10 rounded-xl z-20 overflow-hidden flex flex-col transition-all duration-300 shadow-2xl opacity-0 pointer-events-none translate-y-10">
                <div class="px-4 py-2 border-b border-white/5 flex items-center justify-between bg-white/5">
                    <div class="flex items-center space-x-2">
                        <div class="w-1.5 h-1.5 rounded-full bg-amber-500 animate-pulse"></div>
                        <span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">Interactive Command Terminal</span>
                    </div>
                </div>
                <div id="log-container" class="p-4 text-[10px] mono text-gray-400 space-y-1 overflow-y-auto flex-grow console-scrollbar">
                    <div class="text-amber-500/50 italic mb-2">// System ready. Type '/help' for commands.</div>
                </div>
                <div class="p-3 bg-black/40 border-t border-white/5 flex items-center space-x-2">
                    <span class="text-amber-500 text-xs mono font-bold ml-1">></span>
                    <input type="text" id="terminal-input" placeholder="Inject data or /command..." class="bg-transparent border-none text-amber-500 text-xs mono w-full focus:ring-0 placeholder:text-gray-700" autocomplete="off">
                    <span class="w-1.5 h-3 bg-amber-500 cursor-blink"></span>
                </div>
            </div>
        </div>

        <!-- Inspection Drawer -->
        <div id="drawer" class="fixed top-0 right-0 h-full w-full md:w-[520px] bg-[#0f172a] border-l border-white/10 shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 flex flex-col">
            <div class="p-6 border-b border-white/5 flex justify-between items-center bg-gray-900/50">
                <div class="flex items-center space-x-4">
                    <div id="drawer-icon" class="p-3 bg-amber-500/20 rounded-xl text-amber-500 border border-amber-500/20"></div>
                    <div>
                        <h3 id="drawer-name" class="text-xl font-bold text-white">Node Name</h3>
                        <p id="drawer-type" class="text-[10px] uppercase tracking-widest text-gray-500 font-bold">Step Type</p>
                    </div>
                </div>
                <button onclick="closeDrawer()" class="p-2 hover:bg-white/5 rounded-full text-gray-400 transition-all">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="p-8 space-y-8 overflow-y-auto flex-grow">
                <section class="bg-amber-500/5 border border-amber-500/20 p-5 rounded-2xl">
                    <h4 class="text-[10px] font-bold text-amber-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                        <i data-lucide="lightbulb" class="w-3 h-3"></i> Plain English Metaphor
                    </h4>
                    <p id="drawer-metaphor" class="text-sm text-amber-100/90 leading-relaxed italic"></p>
                </section>

                <section>
                    <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                        <i data-lucide="target" class="w-3 h-3"></i> The Main Goal
                    </h4>
                    <p id="drawer-purpose" class="text-sm text-gray-300 leading-relaxed font-medium"></p>
                </section>

                <section>
                    <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                        <i data-lucide="terminal" class="w-3 h-3"></i> The "How it Works" Logic
                    </h4>
                    <div id="drawer-logic" class="bg-black/40 border border-white/5 rounded-xl p-5 text-xs text-gray-300 leading-relaxed mono whitespace-pre-wrap border-l-2 border-l-blue-500/50"></div>
                </section>

                <div class="bg-gray-900/50 p-5 rounded-2xl border border-white/5">
                    <h4 class="text-[10px] font-bold text-amber-500 uppercase mb-3">The Stack</h4>
                    <div id="drawer-tools" class="flex flex-wrap gap-2"></div>
                </div>

                <section>
                    <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">Live Execution Trace</h4>
                    <div class="space-y-4">
                        <div class="bg-black/60 rounded-xl border border-blue-500/20 overflow-hidden">
                            <div class="bg-blue-500/10 px-3 py-1.5 border-b border-blue-500/20 flex justify-between items-center">
                                <span class="text-[9px] font-bold text-blue-400 mono uppercase tracking-widest">Input Payload</span>
                                <i data-lucide="arrow-right-circle" class="w-3 h-3 text-blue-400 opacity-50"></i>
                            </div>
                            <pre id="drawer-input" class="p-4 text-[10px] text-blue-300/80 overflow-x-auto mono"></pre>
                        </div>
                        <div class="bg-black/60 rounded-xl border border-purple-500/20 overflow-hidden">
                            <div class="bg-purple-500/10 px-3 py-1.5 border-b border-purple-500/20 flex justify-between items-center">
                                <span class="text-[9px] font-bold text-purple-400 mono uppercase tracking-widest">Processed Output</span>
                                <i data-lucide="check-circle" class="w-3 h-3 text-purple-400 opacity-50"></i>
                            </div>
                            <pre id="drawer-output" class="p-4 text-[10px] text-purple-300/80 overflow-x-auto mono"></pre>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <script>
        const scenarioData = {
            'mother-ai': {
                title: "Mother AI Orchestrator",
                summary: "The central intelligence that learns from its own reflections. Features a dual-persistence memory model and a conversational 'Echo' agent for meta-cognitive oversight.",
                nodes: [
                    { id: 'm1', x: 100, y: 300, type: 'Input', name: 'Event Listener', icon: 'eye', tool: 'Git/FileWatcher', purpose: 'Detects systemic changes and project history logs.', logic: 'Summarizes history to optimize context window for LLMs.', metaphor: 'A Watchman at the gate, writing down everything in a notebook.', statusText: 'LISTENING', tools: ['Git API', 'Python'], input: 'Git Diff: modified app_controller.py', output: 'Context: Summarized Data' },
                    { id: 'm2', x: 400, y: 300, type: 'Core', name: 'Mother Core', icon: 'cpu', tool: 'Python/Tkinter', purpose: 'Central logic engine that handles orchestration and delegation.', logic: 'Directs all traffic. Manages frame transitions and global styling.', metaphor: 'The Librarian who knows where every book is.', statusText: 'ORCHESTRATING', tools: ['Python', 'Tkinter'], input: 'Context: Summarized Data', output: 'Action: Trigger Reflection' },
                    { id: 'm3', x: 700, y: 300, type: 'Memory', name: 'Project Memory', icon: 'save', tool: 'YAML/Local', purpose: 'Local learning layer for project-specific context.', logic: 'Stores local reflection logs and project-specific scores.', metaphor: 'The specific notebook for just this project.', statusText: 'SAVING LOCAL', tools: ['PyYAML'], input: 'Reflection Data', output: 'Local State: Updated' },
                    { id: 'm4', x: 700, y: 100, type: 'Agent', name: 'Echo Engine', icon: 'message-circle', tool: 'LLM Agent', purpose: 'Conversational unit for interpretation and interaction.', logic: 'Adjusts behavior based on accumulated insights.', metaphor: 'The personal assistant who talks you through the plan.', statusText: 'INTERPRETING', tools: ['Gemini 1.5', 'OpenAI'], input: 'Goal: Optimize Memory', output: 'Advice: Compress YAML files' },
                    { id: 'm5', x: 1000, y: 100, type: 'Gateway', name: 'Zapier Gateway', icon: 'zap', tool: 'Zapier API', purpose: 'External synchronization and automation trigger.', logic: 'Syncs project events to external CRM or Slack via webhooks.', metaphor: 'The diplomat sending letters to other kingdoms.', statusText: 'SYNCING GATEWAY', tools: ['Zapier', 'Webhooks'], input: 'Event: Project Milestone', output: 'External: Success' },
                    { id: 'm6', x: 1000, y: 300, type: 'Global', name: 'World Memory', icon: 'database', tool: 'PostgreSQL', purpose: 'Global distilled knowledge bank for generalized insights.', logic: 'Stabilization rules: Insights become STABLE after 5 reinforcements.', metaphor: 'The Master Encyclopedia that never forgets life lessons.', statusText: 'SYNCING GLOBAL', tools: ['PostgreSQL', 'SQLAlchemy'], input: 'Insight: Rate limit failure', output: 'Heuristic: Add 334ms delay' }
                ],
                edges: [['m1', 'm2'], ['m2', 'm3'], ['m2', 'm4'], ['m4', 'm5'], ['m3', 'm6'], ['m5', 'm6']]
            },
            'aethelgard': {
                title: "Aethelgard: The Guild's Path",
                summary: "A Discord-based RPG system featuring a Day/Night cycle, deterministic world logic, and character state persistence (HP/Hunger) managed via SQLite.",
                nodes: [
                    { id: 'a1', x: 100, y: 300, type: 'Input', name: 'Slash Command', icon: 'terminal', tool: 'discord.py', purpose: 'Capture player intent via Discord interactions.', logic: 'Parses commands and respects Day/Night cycle.', metaphor: 'Dropping a letter in a mailbox; it knows where to go.', statusText: 'PARSING', tools: ['Python'], input: '/explore [Oskhaven]', output: 'Status: PROCEEDING' },
                    { id: 'a2', x: 400, y: 300, type: 'State', name: 'Session Controller', icon: 'user-check', tool: 'Logic Cog', purpose: 'Validates player stats before allowing game-loop entry.', logic: 'Constraint Check: If Hunger > 90, block travel.', metaphor: 'A Bouncer at a club checking if you are too tired to enter.', statusText: 'VALIDATING', tools: ['Python Logic'], input: '{"HP": 44, "Hunger": 94}', output: '{"can_proceed": true}' },
                    { id: 'a3', x: 700, y: 300, type: 'World', name: 'Encounter Engine', icon: 'map', tool: 'Gloom System', purpose: 'Deterministic world logic based on location and rank.', logic: 'RNG Guardrails: Difficulty scales with player rank.', metaphor: 'A Dungeon Master rolling dice to decide what you run into.', statusText: 'ROLLING...', tools: ['Python'], input: 'Loc: Whisperwood Grove', output: 'Encounter: Fungus' },
                    { id: 'a4', x: 1000, y: 300, type: 'Logic', name: 'Level Up Handler', icon: 'trending-up', tool: 'Skill Engine', purpose: 'Calculates XP and manages rank/evolution thresholds.', logic: 'Updates rank (e.g., Novice -> Champion) based on Crest collection.', metaphor: 'The judge counting your trophies to award a bigger medal.', statusText: 'CALCULATING', tools: ['Python'], input: 'Exp: +15', output: 'Rank: Updated' },
                    { id: 'a5', x: 1000, y: 100, type: 'World', name: 'Gloom Persistence', icon: 'cloud-drizzle', tool: 'Effect Engine', purpose: 'Calculates the spread of corruption in the local region.', logic: 'Applies Gloom-Touched modifiers to flora/fauna.', metaphor: 'The weather changing as the storm gets closer.', statusText: 'SPREADING GLOOM', tools: ['Python'], input: 'Region: Sunstone', output: 'Gloom: +5%' },
                    { id: 'a6', x: 1300, y: 300, type: 'Database', name: 'Persistent Storage', icon: 'database', tool: 'SQLite', purpose: 'Logs world events and player state changes.', logic: 'Final CRUD Operations for the session.', metaphor: 'The Scorekeeper in a board game writing in a permanent notebook.', statusText: 'SYNCING DB', tools: ['SQLite', 'PostgreSQL'], input: 'State: Healthy', output: 'SUCCESS' }
                ],
                edges: [['a1', 'a2'], ['a2', 'a3'], ['a3', 'a4'], ['a4', 'a5'], ['a4', 'a6'], ['a5', 'a6']]
            },
            'zapier-debug': {
                title: "Failed Payment Debug",
                summary: "Fixes a critical 'Stale Data' bug in payment reminders. Features a Step 11.5 CRM Lookup and a perfected two-rule filter logic to ensure only unpaid leads receive follow-ups.",
                nodes: [
                    { id: 'z1', x: 150, y: 300, type: 'Trigger', name: 'Stripe Failed Charge', icon: 'zap', tool: 'Stripe API', purpose: 'Captures initial failure.', logic: 'Captures charge ID and failed status from Step 1. Data frozen until delay ends.', metaphor: 'Taking a snapshot of a moving train.', statusText: 'TRIGGERING', tools: ['Stripe'], input: '{"status": "failed"}', output: '{"status": "failed"}' },
                    { id: 'z2', x: 450, y: 300, type: 'Delay', name: '24-Hour Buffer', icon: 'clock', tool: 'Zapier Delay', purpose: 'Wait period for customer retry.', logic: 'Pauses execution for 24 hours to allow customer self-correction.', metaphor: 'Putting a letter in the "Outbox" for the morning mail.', statusText: 'WAITING (24H)', tools: ['Zapier'], input: '{"delay": "24h"}', output: '{"status": "resumed"}' },
                    { id: 'z3', x: 750, y: 300, type: 'Lookup', name: 'Visa CRM Live Sync', icon: 'search', tool: 'CRM API', purpose: 'Refreshes Source of Truth post-delay.', logic: 'Step 11.5: Re-fetches the actual \"Deal Status\" from the Visa Applicant CRM to bypass stale Stripe triggers.', metaphor: 'Looking out the window to see where the train is now.', statusText: 'REFRESHING...', tools: ['CRM API', 'Step 11.5'], input: '{"email": "user@test.com"}', output: '{"Status": "Deal won!"}' },
                    { id: 'z4', x: 1050, y: 300, type: 'Router', name: 'Precision Filter Gate', icon: 'filter', tool: 'Zapier Filter', purpose: 'Perfected Two-Rule Logic Gate.', logic: 'Rule 1: Record Found (checks CRM existence). Rule 2: CRM Status Found (must NOT equal \"Deal won!\"). HALTS if Record Not Found OR Paid.', metaphor: 'Checking both the passenger ID and the ticket status before boarding.', statusText: 'FILTERING', tools: ['Filter', 'Logic v2.0'], input: '{"Status": "Deal won!"}', output: 'HALT (VALID FIX)' },
                    { id: 'z5', x: 1350, y: 300, type: 'Action', name: 'Follow-up Email', icon: 'mail', tool: 'Gmail API', purpose: 'Re-engages the customer to resolve the payment failure.', logic: 'Final Step 13: Sends the personalized follow-up only if Rule 2 passes.', metaphor: 'The mailman finally delivering the letter because the address was confirmed.', statusText: 'SENDING...', tools: ['Gmail API', 'Step 13'], input: '{"Status": "unpaid"}', output: '{"email_sent": true}' }
                ],
                edges: [['z1', 'z2'], ['z2', 'z3'], ['z3', 'z4'], ['z4', 'z5']]
            },
            'attorney': {
                title: "Attorney Pipeline v2.0",
                summary: "Production-ready system that qualifies immigration attorneys using a 3-Phase approach. Incorporates a Google Sheets buffer for stability and a 5-layer weighted dedupe logic.",
                nodes: [
                    { id: 'at1', x: 100, y: 300, type: 'Trigger', name: 'Notion Trigger', icon: 'zap', tool: 'Notion Button', purpose: 'Phase 1: Manual on-demand initiation.', logic: 'Webhook sends session metadata to Zapier. Intentional manual trigger to control web scraping costs.', metaphor: 'Turning on the tap only when you need water.', statusText: 'ACTIVATING', tools: ['Notion'], input: '{"action": "START"}', output: '{"status": "SCOUTING"}' },
                    { id: 'at2', x: 400, y: 300, type: 'Scout', name: 'Relevance AI Scout', icon: 'search', tool: 'Relevance AI', purpose: 'Web acquisition via scraping.', logic: 'Searches Google and attorney sites. Extracting Firm, Email, and Practice Areas.', metaphor: 'An assistant scanning phone books for keywords.', statusText: 'SCRAPING', tools: ['Relevance AI'], input: '{"query": "Immigration"}', output: '{"profiles": [25]}' },
                    { id: 'at3', x: 700, y: 300, type: 'Queue', name: 'Google Sheets Buffer', icon: 'layers', tool: 'GSheets', purpose: 'Stability Intermediary.', logic: 'V2.0 Core Change: Intermediary queue between Relevance AI and Zapier to eliminate unstable direct connections.', metaphor: 'A cargo check area before the warehouse.', statusText: 'QUEUING', tools: ['Google Sheets'], input: '{"batch": 25}', output: '{"status": "BUFFERED"}' },
                    { id: 'at4', x: 1000, y: 300, type: 'Logic', name: '5-Layer Dedupe', icon: 'filter', tool: 'Python', purpose: 'Weighted duplicate detection.', logic: 'Checks Name, Email, Firm, Web, and Phone. Uses random delays (3-8s) to respect Notion rate limits.', metaphor: 'Security guard checking ID, Face, and Fingerprints.', statusText: 'DEDUPING', tools: ['Python', 'Zapier'], input: '{"email": "kyle@legal.com"}', output: '{"is_unique": true}' },
                    { id: 'at5', x: 1300, y: 300, type: 'Phase 2', name: 'Gemini Classifier', icon: 'shield-check', tool: 'Gemini Flash 2.0', purpose: 'Immigration Focus classification.', logic: 'Grades leads: HIGH / MEDIUM / LOW focus. Questionable leads flagged for review.', metaphor: 'Sorting mail into important, standard, and junk.', statusText: 'CLASSIFYING', tools: ['Gemini Flash 2.0'], input: '{"practice_areas": "..."}', output: '{"focus": "HIGH"}' },
                    { id: 'at6', x: 1600, y: 300, type: 'Phase 3', name: 'GPT-4o Drafter', icon: 'pen-tool', tool: 'OpenAI GPT-4o', purpose: 'Personalized email outreach generation.', logic: 'Phase 3: Creates customized drafts based on practice details. Manual trigger for final review.', metaphor: 'A professional ghostwriter drafting a reply.', statusText: 'DRAFTING', tools: ['GPT-4o'], input: '{"lead": "HIGH focus"}', output: '{"draft": "Hello Attorney..."}' }
                ],
                edges: [['at1', 'at2'], ['at2', 'at3'], ['at3', 'at4'], ['at4', 'at5'], ['at5', 'at6']]
            },
            'helpscout': {
                title: "Help Scout Sage",
                summary: "High-performance AI Draft Generator for customer support agents. Features multi-step intent profiling and tone optimization to ensure human-like drafts posted as internal notes.",
                nodes: [
                    { id: 'hs1', x: 100, y: 300, type: 'Trigger', name: 'Sidebar Trigger', icon: 'mouse-pointer-2', tool: 'Help Scout App', purpose: 'Agent-activated draft request.', logic: 'Custom sidebar app sends conversation ID to Node.js backend.', metaphor: 'Ringing the bell for a waiter.', statusText: 'TRIGGERING', tools: ['Vanilla JS', 'HS App SDK'], input: '{"id": "3107"}', output: '{"status": "SAGE_CALL"}' },
                    { id: 'hs2', x: 400, y: 300, type: 'Context', name: 'Context Fetcher', icon: 'file-search', tool: 'Node.js', purpose: 'Fetches thread history.', logic: 'Retrieves all threads via HS API to provide full context for the LLM.', metaphor: 'Assistant reading old letters in a file.', statusText: 'FETCHING', tools: ['Node.js', 'HS API'], input: '{"id": "3107"}', output: '{"threads": [...]}' },
                    { id: 'hs3', x: 700, y: 300, type: 'Intelligence', name: 'Intent Profiler', icon: 'brain-circuit', tool: 'LLM Analysis', purpose: 'Categorizes ticket and mood.', logic: 'Analyzes latest customer message for sentiment and intent (e.g., Refund, Bug, Feature).', metaphor: 'Reading the room before speaking.', statusText: 'PROFILING', tools: ['Gemini'], input: '{"latest": "Refund?"}', output: '{"intent": "billing"}' },
                    { id: 'hs4', x: 1000, y: 300, type: 'AI Agent', name: 'Sage Engine', icon: 'sparkles', tool: 'Gemini', purpose: 'Core draft generation.', logic: 'Generates a personalized draft based on thread history and brand guidelines.', metaphor: 'Ghostwriter drafting a response.', statusText: 'DRAFTING', tools: ['Gemini'], input: '{"intent": "billing"}', output: '{"draft": "Hello..."}' },
                    { id: 'hs5', x: 1300, y: 300, type: 'Quality', name: 'Tone & Polish', icon: 'check-check', tool: 'Draft Optimization', purpose: 'Ensures brand voice alignment.', logic: 'Secondary LLM pass to ensure formatting, brevity, and tone matches support guidelines.', metaphor: 'A proofreader checking the draft for errors.', statusText: 'POLISHING', tools: ['OpenAI'], input: '{"draft": "..."}', output: '{"final": "..."}' },
                    { id: 'hs6', x: 1600, y: 300, type: 'Action', name: 'Note Injection', icon: 'send', tool: 'HS API', purpose: 'Inserts draft as internal note.', logic: 'Posts the final polished draft as a Private Note in the Help Scout thread.', metaphor: 'Placing a sticky note on a file for approval.', statusText: 'POSTING', tools: ['HS API'], input: '{"draft": true}', output: '{"status": "CREATED"}' }
                ],
                edges: [['hs1', 'hs2'], ['hs2', 'hs3'], ['hs3', 'hs4'], ['hs4', 'hs5'], ['hs5', 'hs6']]
            },
            'ai-validation': {
                title: "AI Validation Flow",
                summary: "A robust lead quality gate that uses semantic validation to filter out spam and deceptive data, ensuring 96%+ CRM hygiene.",
                nodes: [
                    { id: 'v1', x: 100, y: 300, type: 'Trigger', name: 'Webhook Ingest', icon: 'zap', tool: 'Webhook', purpose: 'Captures raw lead data.', logic: 'Primary listener for system input.', metaphor: 'A mailbox catching letters.', statusText: 'INGESTING', tools: ['Make'], input: '{"name": "Ky"}', output: '{"raw": {...}}' },
                    { id: 'v2', x: 400, y: 300, type: 'AI Agent', name: 'Gemini Gatekeeper', icon: 'shield-check', tool: 'Gemini', purpose: 'Hardened semantic validation.', logic: 'Returns failure codes for non-professional input.', metaphor: 'Quality inspector tossing out dented cans.', statusText: 'VALIDATING', tools: ['Gemini'], input: '{"about": "crypto"}', output: '{"valid": false}' },
                    { id: 'v3', x: 700, y: 300, type: 'Router', name: 'Decision Gate', icon: 'git-branch', tool: 'Router', purpose: 'Directs data based on success codes.', logic: 'Checks AI output for success codes and hygiene.', metaphor: 'A traffic light for inspected cars.', statusText: 'ROUTING', tools: ['Make'], input: '{"valid": false}', output: 'Route: Fallback' },
                    { id: 'v4', x: 1000, y: 100, type: 'Action', name: 'CRM Success', icon: 'check-circle', tool: 'CRM/Database', purpose: 'Primary data storage for valid leads.', logic: 'Logs enriched data to Salesforce/GSheets.', metaphor: 'Putting the perfect apple on the store shelf.', statusText: 'POSTING CRM', tools: ['Salesforce', 'Google Sheets'], input: '{"valid": true}', output: 'CRM: Updated' },
                    { id: 'v5', x: 1250, y: 100, type: 'Action', name: 'Slack Alert', icon: 'slack', tool: 'Slack API', purpose: 'Instant notification for new high-quality leads.', logic: 'Sends formatted message with lead context.', metaphor: 'Ringing the victory bell.', statusText: 'NOTIFYING', tools: ['Slack'], input: 'CRM: Updated', output: 'Slack: Sent' },
                    { id: 'v6', x: 1000, y: 450, type: 'Action', name: 'Fallback: Error Log', icon: 'alert-triangle', tool: 'PostgreSQL', purpose: 'Integrity fallback for suspicious data.', logic: 'Logs raw input for manual review.', metaphor: 'The "Lost and Found" box.', statusText: 'LOGGING FAIL', tools: ['PostgreSQL'], input: '{"fail": "junk"}', output: '{"logged": true}' }
                ],
                edges: [['v1', 'v2'], ['v2', 'v3'], ['v3', 'v4'], ['v4', 'v5'], ['v3', 'v6']]
            }
        };

        let activeScenario = 'mother-ai';
        let isSimulating = false;

        function addLog(message, type = 'info') {
            const container = document.getElementById('log-container');
            if (!container) return;
            const log = document.createElement('div');
            const time = new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            let prefix = `[${time}] `;
            if (type === 'ai') {
                log.className = "p-3 ai-response my-2 rounded-r-lg";
                prefix = `<span class="text-amber-500 font-bold tracking-widest text-[8px] block mb-1">SYSTEM_AI_AGENT</span>`;
            } else if (type === 'success') log.className = "text-green-400";
            else if (type === 'process') log.className = "text-amber-400 font-bold";
            else if (type === 'system') log.className = "text-blue-400";
            else if (type === 'user') log.className = "text-amber-500 font-bold";
            else if (type === 'error') log.className = "text-red-400 font-bold";
            else log.className = "text-gray-500";
            log.innerHTML = `${prefix} ${message}`;
            container.appendChild(log);
            container.scrollTop = container.scrollHeight;
        }

        function toggleTerminal(force) {
            const terminal = document.getElementById('live-terminal');
            const btn = document.getElementById('term-toggle-btn');
            const isHidden = terminal.style.opacity === '0';
            const newState = (force !== undefined) ? force : isHidden;
            if (newState) {
                terminal.style.opacity = '1'; terminal.classList.remove('pointer-events-none', 'translate-y-10');
                btn.classList.add('bg-amber-500/10', 'border-amber-500/50', 'text-amber-500');
            } else {
                terminal.style.opacity = '0'; terminal.classList.add('pointer-events-none', 'translate-y-10');
                btn.classList.remove('bg-amber-500/10', 'border-amber-500/50', 'text-amber-500');
            }
        }

        document.getElementById('terminal-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const val = this.value.trim();
                if (!val) return;
                if (val.startsWith('/')) handleCommand(val.substring(1));
                else { addLog(`INJECTED: "${val}"`, 'user'); startSimulation(val); }
                this.value = '';
            }
        });

        function handleCommand(cmd) {
            const scenario = scenarioData[activeScenario];
            switch(cmd.toLowerCase()) {
                case 'help': addLog(`Commands: /summarize, /status, /clear, /hide`, 'system'); break;
                case 'summarize': addLog(scenario.summary, 'ai'); break;
                case 'status': addLog(`Latency: 8ms | DB: CONNECTED`, 'system'); break;
                case 'clear': document.getElementById('log-container').innerHTML = ''; break;
                case 'hide': toggleTerminal(false); break;
            }
        }

        function loadScenario(id) {
            if (isSimulating) stopSimulation();
            activeScenario = id;
            const data = scenarioData[id];
            if (!data) return;
            document.getElementById('scenario-title').innerText = data.title;
            document.querySelectorAll('nav button').forEach(btn => btn.className = "w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 text-sm font-medium flex items-center justify-between transition-all group");
            const activeBtn = document.getElementById(`btn-${id}`);
            if(activeBtn) activeBtn.className = "w-full text-left px-4 py-3 rounded-lg bg-amber-500/10 border border-amber-500/50 text-amber-500 text-sm font-bold flex items-center justify-between group";
            renderCanvas();
        }

        function renderCanvas() {
            const data = scenarioData[activeScenario];
            const nodeLayer = document.getElementById('node-layer');
            const svgLayer = document.getElementById('svg-layer');
            nodeLayer.innerHTML = ''; svgLayer.innerHTML = '';
            data.edges.forEach((edge, idx) => {
                const source = data.nodes.find(n => n.id === edge[0]);
                const target = data.nodes.find(n => n.id === edge[1]);
                if (!source || !target) return;
                const x1 = source.x + 192, y1 = source.y + 70, x2 = target.x, y2 = target.y + 70;
                const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
                line.setAttribute("d", `M ${x1} ${y1} C ${x1 + (x2-x1)/2} ${y1}, ${x1 + (x2-x1)/2} ${y2}, ${x2} ${y2}`);
                line.setAttribute("id", `path-${activeScenario}-${idx}`);
                line.setAttribute("stroke", "#374151"); line.setAttribute("stroke-width", "2");
                line.setAttribute("fill", "none"); line.setAttribute("class", "line-flow");
                svgLayer.appendChild(line);
            });
            data.nodes.forEach(node => {
                const div = document.createElement('div');
                div.id = `node-${node.id}`;
                div.className = "absolute node-card w-48 p-4 rounded-xl cursor-pointer shadow-xl z-10 flex flex-col h-[140px]";
                div.style.left = `${node.x}px`; div.style.top = `${node.y}px`;
                div.onclick = () => openDrawer(node);
                div.innerHTML = `<div class="glow-pulse"></div><span class="text-[9px] font-black text-gray-500 uppercase tracking-widest mb-2">${node.type}</span><div class="flex items-center space-x-3 mb-4"><div class="p-2 bg-gray-800 rounded-lg"><i data-lucide="${node.icon}" class="w-5 h-5"></i></div><h4 class="text-xs font-bold text-white leading-tight">${node.name}</h4></div>`;
                nodeLayer.appendChild(div);
            });
            lucide.createIcons();
        }

        async function startSimulation(manualPayload = null) {
            if (isSimulating) return;
            isSimulating = true; toggleTerminal(true);
            
            const p = manualPayload ? manualPayload.toLowerCase() : '';
            const chaosKeywords = ['fail', 'error', 'junk', 'spam', 'bad', 'paid', 'won', 'shih', 'ssad', 'hsueh'];
            const isChaos = chaosKeywords.some(k => p.includes(k));
            
            addLog(`SYSTEM: INITIATING ${isChaos ? '[CHAOS_TEST]' : '[STANDARD_RUN]'}`, 'system');
            const data = scenarioData[activeScenario];
            const svgLayer = document.getElementById('svg-layer');
            const packet = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            packet.setAttribute("r", "5"); packet.setAttribute("class", "data-packet" + (isChaos ? " error-packet" : ""));
            svgLayer.appendChild(packet);

            const executionPath = [];
            if (activeScenario === 'ai-validation' && isChaos) {
                executionPath.push(['v1', 'v2'], ['v2', 'v3'], ['v3', 'v6']);
            } else if (activeScenario === 'ai-validation' && !isChaos) {
                executionPath.push(['v1', 'v2'], ['v2', 'v3'], ['v3', 'v4'], ['v4', 'v5']);
            } else if (activeScenario === 'zapier-debug' && isChaos) {
                executionPath.push(['z1', 'z2'], ['z2', 'z3'], ['z3', 'z4']);
            } else {
                executionPath.push(...data.edges);
            }

            for (let i = 0; i < executionPath.length; i++) {
                if (!isSimulating) break;
                const edge = executionPath[i];
                const sourceNode = data.nodes.find(n => n.id === edge[0]);
                const targetNode = data.nodes.find(n => n.id === edge[1]);
                const pathId = data.edges.findIndex(e => e[0] === edge[0] && e[1] === edge[1]);
                const path = document.getElementById(`path-${activeScenario}-${pathId}`);
                
                if (sourceNode) {
                    const nodeEl = document.getElementById(`node-${sourceNode.id}`);
                    nodeEl.classList.add('processing');
                    if(isChaos && i > 0) nodeEl.classList.add('failed');
                    openDrawer(sourceNode, (i === 0 && manualPayload) ? manualPayload : sourceNode.input);
                    addLog(`[EXEC] ${sourceNode.name}`, 'process');
                    await new Promise(r => setTimeout(r, 800));
                    
                    if (isChaos && sourceNode.id === 'z4') {
                        addLog(`[HALT] Filter Rule 2: CRM Status = "Deal won!". STOPPING.`, 'error');
                    } else if (isChaos && sourceNode.id === 'v3') {
                        addLog(`[ALERT] Validation Failure code detected. Routing to Fallback.`, 'error');
                    } else {
                        addLog(`[SUCCESS] Verified.`, 'success');
                    }
                    
                    nodeEl.classList.remove('processing');
                }
                if (path) {
                    const length = path.getTotalLength();
                    const start = performance.now();
                    await new Promise(resolve => {
                        function animate(time) {
                            if (!isSimulating) return resolve();
                            const p = Math.min((time - start) / 800, 1);
                            const pt = path.getPointAtLength(p * length);
                            packet.setAttribute("cx", pt.x); packet.setAttribute("cy", pt.y);
                            if (p < 1) requestAnimationFrame(animate); else resolve();
                        }
                        requestAnimationFrame(animate);
                    });
                }
                if (i === executionPath.length - 1 && targetNode) {
                    const finalNodeEl = document.getElementById(`node-${targetNode.id}`);
                    finalNodeEl.classList.add('processing');
                    openDrawer(targetNode);
                    addLog(`[FINAL] ${targetNode.name}: Terminal.`, 'process');
                    await new Promise(r => setTimeout(r, 800));
                    addLog(isChaos ? `[CHAOS] Simulation finished at Catch Gate.` : `[SYSTEM] Pipeline run complete.`, isChaos ? 'error' : 'system');
                    finalNodeEl.classList.remove('processing');
                }
            }
            stopSimulation();
        }

        function stopSimulation() {
            isSimulating = false;
            document.querySelectorAll('.data-packet').forEach(p => p.remove());
            document.querySelectorAll('.node-card').forEach(n => n.classList.remove('processing', 'failed'));
        }

        function openDrawer(node, customInput = null) {
            document.getElementById('drawer-name').innerText = node.name;
            document.getElementById('drawer-purpose').innerText = node.purpose;
            document.getElementById('drawer-logic').innerText = node.logic;
            document.getElementById('drawer-metaphor').innerText = node.metaphor;
            document.getElementById('drawer-input').innerText = customInput || node.input;
            document.getElementById('drawer-output').innerText = node.output;
            document.getElementById('drawer-tools').innerHTML = (node.tools || []).map(tool => `<span class="px-2 py-1 bg-white/5 rounded text-[10px] text-gray-400 font-bold border border-white/5">${tool}</span>`).join('');
            document.getElementById('drawer-icon').innerHTML = `<i data-lucide="${node.icon}" class="w-8 h-8"></i>`;
            document.getElementById('drawer').classList.remove('translate-x-full'); lucide.createIcons();
        }

        function closeDrawer() { document.getElementById('drawer').classList.add('translate-x-full'); }
        window.onload = () => loadScenario('mother-ai');
    </script>
</body>
</html>
